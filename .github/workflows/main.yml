name: Deploy Account Frontend
on:
  push:
    branches: [ dev ]
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout account-frontend
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref_name }}
          path: '.'

      - name: Checkout Terraform
        uses: actions/checkout@v3
        with:
          repository: 'space-metaverse/terraform'
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          path: 'terraform'
      
      - name: Install Terraform
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg  
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update && sudo apt install terraform

      - name: Test setup
        run: ls -la && cd terraform && ls -la

      - name: Terraform Init
        run: |
          chmod +x ./terraform/build_image.sh
          chmod +x ./terraform/deploy_infra.sh
          ./terraform/build_image.sh
          ./terraform/deploy_infra.sh
        env:
          CI_COMMIT_REF_NAME: ${{ github.ref_name }}
          APP_NAME: ${{ secrets.APP_NAME }}
          AWS_ACCESS_KEY_ID: ${{ secrets[format('AWS_ACCESS_KEY_ID_{0}', github.ref_name)] }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets[format('AWS_SECRET_ACCESS_KEY_{0}', github.ref_name)] }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          PATH_PATTERN: ${{ secrets.PATH_PATTERN }}
          CONTAINER_PORT: ${{ secrets.CONTAINER_PORT }}
          VPC_ID: ${{ secrets[format('VPC_ID_{0}', github.ref_name)] }}
          SUBNET_IDS: ${{ secrets[format('SUBNET_IDS_{0}', github.ref_name)] }}
          LISTNER_ARN: ${{ secrets[format('LISTNER_ARN_{0}', github.ref_name)] }}
          CLUSTER_NAME: ${{ secrets[format('CLUSTER_NAME_{0}', github.ref_name)] }}
          BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
          NEXT_ENV_FILE: ${{ secrets[format('NEXT_ENV_{0}', github.ref_name)] }}
          DO_DESTROY: ${{ secrets.DO_DESTROY }}
